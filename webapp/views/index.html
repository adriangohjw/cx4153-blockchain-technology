<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <link rel="stylesheet" href="./stylesheets/style.css">

    <!-- Web3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.0/web3.min.js" integrity="sha512-ppuvbiAokEJLjOUQ24YmpP7tTaLRgzliuldPRZ01ul6MhRC+B8LzcVkXmUsDee7ne9chUfApa9/pWrIZ3rwTFQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.0/web3.js" integrity="sha512-ZsluhyiKawri29YBgjj1mSDXfOq1HVQ34pJkVEdnYmZJD+kEBZ0AjM4v8kGMk6lis3wjZAUUKP0o0QLHy4PmZA==" crossorigin="anonymous"></script>
    <script>
      const web3 = new Web3("<%= web3_http %>");
    </script>

    <title>aDEX</title>
  </head>

  <body>

    <!-- jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    <div class="container-max-width">

      <div class="container mb-4">
        <div class="row">
          <div class="col-6">
            <img src="./images/logo.png" style="width: 40%; min-width: 150px; max-width: 200px;">
          </div>
        </div>
      </div>

      <div class="container mb-4">
        <button class="enableEthereumButton btn btn-sm btn-primary">Enable Ethereum</button>
        <p style="font-weight: bold;">Account: <span class="showAccount"></span></p>
        <hr>
        
        <div class="form-group mt-4">
          <label for="etherAmountToDeposit">Ether amount to deposit</label>
          <input type="number" class="form-control" id="etherAmountToDeposit" placeholder="Enter ether amount to deposit (min. 0.0001 eth)" min="0.0001" step="0.0001">
        </div>
        <button class="depositEtherButton btn btn-sm btn-primary">Deposit Ether</button>
        <br>

        <div class="form-group mt-4">
          <label for="etherAmountToWithdraw">Ether amount to withdraw</label>
          <input type="number" class="form-control" id="etherAmountToWithdraw" placeholder="Enter ether amount to withdraw (min. 0.0001 eth)" min="0.0001" step="0.0001">
        </div>
        <button class="btn btn-sm btn-primary" id="withdrawEtherButton" onclick="withdrawEther()">Withdraw Ether</button>
        <br>
        
        <div class="mt-4">
          <button class="btn btn-sm btn-primary" onclick="updateEtherBalance()">Update Ether balance</button>
          <p style="font-weight: bold;">Ether balance: <span id="etherBalance"></span></p>
        </div>
      </div>
      <hr>

      <div class="container mb-4"> 
        <div class="row mt-4">
          <div class="form-group col">
            <label for="tokenSymbol">Token symbol</label>
            <input type="text" class="form-control" id="tokenSymbol" placeholder="Enter token symbol">
          </div>
        </div>
        <div class="row mt-4">
          <div class="col">
            <label>Token balance</label>
            <p style="font-weight: bold;"><span id="tokenBalance">-</span>&nbsp;</p>
            <button class="btn btn-sm btn-primary" onclick="updateTokenBalance()">Update balance</button>
          </div>
          <div class="form-group col">
            <label for="tokenAmountToDeposit">Amount to deposit</label>
            <input type="number" class="form-control" id="tokenAmountToDeposit" placeholder="Amount to deposit (min. 0.0001)" min="0.0001" step="0.0001">
            <button class="btn btn-sm btn-primary" onclick="depositToken()">Deposit Token</button>
          </div>
          <div class="form-group col">
            <label for="tokenAmountToWithdraw">Amount to withdraw</label>
            <input type="number" class="form-control" id="tokenAmountToWithdraw" placeholder="Amount to withdraw (min. 0.0001)" min="0.0001" step="0.0001">
            <button class="btn btn-sm btn-primary" onclick="withdrawToken()">Withdraw Token</button>
          </div>
        </div>  
      </div>
      <br>

      <div class="container main-dashboard">
        hello<br>
      </div>

    </div>
  </body>
</html>

<script>
  const ethereumButton = document.querySelector('.enableEthereumButton');
  const showAccount = document.querySelector('.showAccount');

  ethereumButton.addEventListener('click', async () => {
    showAccount.innerHTML = await getAccount();
  });

  async function getAccount() {
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    return accounts[0];
  }

  async function getEtherBalanceInWei() {
    response = await fetch(`exchange/getEtherBalanceInWei?addr=${await getAccount()}`, {
      method: 'GET',
      credentials: 'same-origin'
    });
    
    res = await response.json();
    var etherBalanceInWei = res.etherBalanceInWei;

    return etherBalanceInWei;
  }

  async function updateEtherBalance() {
    var etherBalanceInWei = await getEtherBalanceInWei();
    document.getElementById("etherBalance").innerHTML = web3.utils.fromWei(etherBalanceInWei, 'ether');;
  }

  const depositEtherButton = document.querySelector('.depositEtherButton');
  depositEtherButton.addEventListener('click', async () => {
    var amount = document.getElementById("etherAmountToDeposit").value;
    if (amount == "") {
      console.log("Empty value input for etherAmountToDeposit");
      return;
    }

    ethereum
    .request({
      method: 'eth_sendTransaction',
      params: [
        {
          from: await getAccount(),
          to: "<%= contract_address %>",
          value: web3.utils.toHex(web3.utils.toWei(amount)), // have to convert to hexdemical for big number
          data: web3.eth.abi.encodeFunctionCall(
            {
              name: "depositEther",
              type: "function",
              inputs: [],
            },
            []
          ),
          chainId: 3, // ropsten
        }
      ],
    })
    .then((txHash) => {
      console.log(txHash);
      updateEtherBalance();
    })
    .catch((error) => console.error);
  });

  async function withdrawEther() {
    var amountInEther = document.getElementById("etherAmountToWithdraw").value;
    if (amountInEther == "") {
      console.log("Empty value input for etherAmountToWithdraw");
      return;
    }

    var amountInWei = Web3.utils.toWei(amountInEther, 'ether');

    await fetch(`exchange/withdrawEther?addr=${await getAccount()}&amountInWei=${amountInWei}`, {
      method: 'POST',
      credentials: 'same-origin'
    });
    
    updateEtherBalance();
  }

  async function getTokenBalance() {
    var symbolName = document.getElementById("tokenSymbol").value;

    response = await fetch(`exchange/getBalanceForToken?symbolName=${symbolName}&addr=${await getAccount()}`, {
      method: 'GET',
      credentials: 'same-origin'
    });
    
    res = await response.json();
    var tokenBalance = res.balanceForToken;

    return tokenBalance;
  }

  async function updateTokenBalance() {
    var tokenBalance = await getTokenBalance();
    document.getElementById("tokenBalance").innerHTML = tokenBalance;
  }

  async function depositToken(){
    var symbolName = document.getElementById("tokenSymbol").value;
    var amount = document.getElementById("tokenAmountToDeposit").value;
    if (amount == "") {
      console.log("Empty value input for tokenAmountToDeposit");
      return;
    }

    await fetch(`exchange/depositToken?addr=${await getAccount()}&symbolName=${symbolName}&amount=${amount}`, {
      method: 'POST',
      credentials: 'same-origin'
    });

    updateTokenBalance();
  }

  async function withdrawToken(){
    var symbolName = document.getElementById("tokenSymbol").value;
    var amount = document.getElementById("tokenAmountToWithdraw").value;
    if (amount == "") {
      console.log("Empty value input for tokenAmountToWithdraw");
      return;
    }

    await fetch(`exchange/withdrawToken?addr=${await getAccount()}&symbolName=${symbolName}&amount=${amount}`, {
      method: 'POST',
      credentials: 'same-origin'
    });

    updateTokenBalance();
  }
</script>